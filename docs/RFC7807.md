# RFC 7807: Problem Details for HTTP APIs

## Resumen

RFC 7807 define un formato estándar para reportar errores en APIs HTTP de forma consistente y extensible. Este proyecto implementa este estándar para todas las respuestas de error.

## Estructura del Problem Details

```json
{
  "type": "https://api.grupoapi.com/problems/tipo-error",
  "title": "Título Breve del Error",
  "status": 400,
  "detail": "Explicación detallada de lo que salió mal",
  "instance": "/ruta/del/endpoint"
}
```

### Campos

| Campo | Tipo | Requerido | Descripción |
|-------|------|-----------|-------------|
| `type` | URI | Sí | Identificador único del tipo de problema. Debe ser una URI que pueda documentar el error |
| `title` | string | Sí | Resumen legible del tipo de problema (no debe cambiar entre ocurrencias del mismo tipo) |
| `status` | integer | Sí | Código de estado HTTP (debe coincidir con el código de respuesta) |
| `detail` | string | No | Explicación específica de esta ocurrencia del problema |
| `instance` | URI | No | URI que identifica la ocurrencia específica del problema |

## Tipos de Errores del Dominio

### 1. Errores de Validación (400 Bad Request)

#### Nombre Inválido

```json
{
  "type": "https://api.grupoapi.com/problems/invalid-name",
  "title": "Invalid Task Name",
  "status": 400,
  "detail": "Name must be alphanumeric with spaces, hyphens, or underscores. Maximum 256 characters. Received: '@@Invalid@Name@@'",
  "instance": "/Automatizacion"
}
```

**Cuándo:** El nombre de tarea/subtarea no cumple con el patrón `^[a-zA-Z0-9 _-]+$` o excede 256 caracteres.

#### Transición de Estado Inválida

```json
{
  "type": "https://api.grupoapi.com/problems/invalid-state-transition",
  "title": "Invalid State Transition",
  "status": 400,
  "detail": "Cannot transition from COMPLETED to PENDING. Final states (COMPLETED, FAILED, CANCELLED) cannot be reverted.",
  "instance": "/Automatizacion"
}
```

**Cuándo:** Se intenta cambiar el estado de una tarea/subtarea de forma no permitida por la máquina de estados.

**Transiciones válidas:**
- `PENDING` → `IN_PROGRESS`, `CANCELLED`
- `IN_PROGRESS` → `COMPLETED`, `FAILED`
- `COMPLETED` → (ninguna, estado final)
- `FAILED` → (ninguna, estado final)
- `CANCELLED` → (ninguna, estado final)

#### Estado Inconsistente Padre-Hijo

```json
{
  "type": "https://api.grupoapi.com/problems/inconsistent-parent-child-state",
  "title": "Inconsistent Parent-Child State",
  "status": 400,
  "detail": "Subtask cannot have state IN_PROGRESS when parent task is in final state COMPLETED. Subtasks must inherit parent's final state.",
  "instance": "/Subtask/660e8400-e29b-41d4-a716-446655440001"
}
```

**Cuándo:** Una subtarea intenta tener un estado activo cuando su tarea padre está en estado final.

**Regla:** Si una tarea está en estado final (COMPLETED, FAILED, CANCELLED), todas sus subtareas deben heredar ese mismo estado.

#### Campos Requeridos Faltantes

```json
{
  "type": "https://api.grupoapi.com/problems/missing-required-fields",
  "title": "Missing Required Fields",
  "status": 400,
  "detail": "The following required fields are missing: 'name', 'created_by'",
  "instance": "/Automatizacion"
}
```

**Cuándo:** El request no incluye campos obligatorios.

### 2. Errores de Recursos No Encontrados (404 Not Found)

#### Tarea No Encontrada

```json
{
  "type": "https://api.grupoapi.com/problems/task-not-found",
  "title": "Task Not Found",
  "status": 404,
  "detail": "Task with ID '550e8400-e29b-41d4-a716-446655440000' does not exist or has been deleted.",
  "instance": "/Automatizacion/550e8400-e29b-41d4-a716-446655440000"
}
```

**Cuándo:** 
- El UUID de tarea no existe en BD
- La tarea está marcada como eliminada (soft delete, `deleted_at IS NOT NULL`)

#### Subtarea No Encontrada

```json
{
  "type": "https://api.grupoapi.com/problems/subtask-not-found",
  "title": "Subtask Not Found",
  "status": 404,
  "detail": "Subtask with ID '660e8400-e29b-41d4-a716-446655440001' does not exist or has been deleted.",
  "instance": "/Subtask/660e8400-e29b-41d4-a716-446655440001"
}
```

**Cuándo:** El UUID de subtarea no existe o está eliminada.

### 3. Errores de Servidor (500 Internal Server Error)

#### Error de Base de Datos

```json
{
  "type": "https://api.grupoapi.com/problems/database-error",
  "title": "Database Error",
  "status": 500,
  "detail": "An unexpected database error occurred. Please try again later.",
  "instance": "/Automatizacion"
}
```

**Cuándo:** Ocurre un error inesperado al interactuar con PostgreSQL.

**Nota:** No se deben exponer detalles internos de la base de datos en el campo `detail` por seguridad.

#### Error Genérico

```json
{
  "type": "https://api.grupoapi.com/problems/internal-error",
  "title": "Internal Server Error",
  "status": 500,
  "detail": "An unexpected error occurred. Please contact support if the problem persists.",
  "instance": "/Automatizacion"
}
```

**Cuándo:** Error inesperado no categorizado.

### 4. Errores de Servicio No Disponible (503 Service Unavailable)

#### Base de Datos No Disponible

```json
{
  "type": "https://api.grupoapi.com/problems/database-unavailable",
  "title": "Database Unavailable",
  "status": 503,
  "detail": "Cannot connect to database. Service is temporarily unavailable.",
  "instance": "/health"
}
```

**Cuándo:** La conexión a PostgreSQL falla (detectado en health check o durante operación).

## Mapeo de Errores de Dominio a HTTP

### Errores de Dominio (internal/domain/entity/errors.go)

| Error de Dominio | Código HTTP | Type URI |
|------------------|-------------|----------|
| `ErrInvalidName` | 400 | `/problems/invalid-name` |
| `ErrInvalidStateTransition` | 400 | `/problems/invalid-state-transition` |
| `ErrInconsistentParentChildState` | 400 | `/problems/inconsistent-parent-child-state` |
| `ErrTaskNotFound` | 404 | `/problems/task-not-found` |
| `ErrSubtaskNotFound` | 404 | `/problems/subtask-not-found` |
| `ErrMissingRequiredFields` | 400 | `/problems/missing-required-fields` |
| `ErrDatabaseError` | 500 | `/problems/database-error` |
| `ErrDatabaseUnavailable` | 503 | `/problems/database-unavailable` |

### Implementación en Handlers

```go
// internal/adapter/handler/http/error_mapper.go

package http

import (
    "errors"
    "net/http"
    
    "github.com/gin-gonic/gin"
    "github.com/grupoapi/proces-log/internal/domain/entity"
)

type ProblemDetails struct {
    Type     string `json:"type"`
    Title    string `json:"title"`
    Status   int    `json:"status"`
    Detail   string `json:"detail"`
    Instance string `json:"instance"`
}

func MapErrorToProblemDetails(c *gin.Context, err error) {
    var pd ProblemDetails
    pd.Instance = c.Request.URL.Path
    
    switch {
    case errors.Is(err, entity.ErrInvalidName):
        pd.Type = "https://api.grupoapi.com/problems/invalid-name"
        pd.Title = "Invalid Task Name"
        pd.Status = http.StatusBadRequest
        pd.Detail = err.Error()
        
    case errors.Is(err, entity.ErrInvalidStateTransition):
        pd.Type = "https://api.grupoapi.com/problems/invalid-state-transition"
        pd.Title = "Invalid State Transition"
        pd.Status = http.StatusBadRequest
        pd.Detail = err.Error()
        
    case errors.Is(err, entity.ErrInconsistentParentChildState):
        pd.Type = "https://api.grupoapi.com/problems/inconsistent-parent-child-state"
        pd.Title = "Inconsistent Parent-Child State"
        pd.Status = http.StatusBadRequest
        pd.Detail = err.Error()
        
    case errors.Is(err, entity.ErrTaskNotFound):
        pd.Type = "https://api.grupoapi.com/problems/task-not-found"
        pd.Title = "Task Not Found"
        pd.Status = http.StatusNotFound
        pd.Detail = err.Error()
        
    case errors.Is(err, entity.ErrSubtaskNotFound):
        pd.Type = "https://api.grupoapi.com/problems/subtask-not-found"
        pd.Title = "Subtask Not Found"
        pd.Status = http.StatusNotFound
        pd.Detail = err.Error()
        
    default:
        pd.Type = "https://api.grupoapi.com/problems/internal-error"
        pd.Title = "Internal Server Error"
        pd.Status = http.StatusInternalServerError
        pd.Detail = "An unexpected error occurred"
    }
    
    c.JSON(pd.Status, pd)
}
```

## Ejemplos de Uso

### Crear Tarea con Nombre Inválido

**Request:**
```bash
POST /Automatizacion
Content-Type: application/json

{
  "name": "@@Invalid@@",
  "created_by": "Equipo Test"
}
```

**Response:**
```http
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "type": "https://api.grupoapi.com/problems/invalid-name",
  "title": "Invalid Task Name",
  "status": 400,
  "detail": "Name must be alphanumeric with spaces, hyphens, or underscores. Maximum 256 characters. Received: '@@Invalid@@'",
  "instance": "/Automatizacion"
}
```

### Actualizar con Transición Inválida

**Request:**
```bash
PUT /Automatizacion
Content-Type: application/json

{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "state": "PENDING",
  "updated_by": "Equipo Test"
}
```

**Response (si la tarea estaba en COMPLETED):**
```http
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "type": "https://api.grupoapi.com/problems/invalid-state-transition",
  "title": "Invalid State Transition",
  "status": 400,
  "detail": "Cannot transition from COMPLETED to PENDING. Final states cannot be reverted.",
  "instance": "/Automatizacion"
}
```

### Obtener Tarea Inexistente

**Request:**
```bash
GET /Automatizacion/999e8400-e29b-41d4-a716-446655440000
```

**Response:**
```http
HTTP/1.1 404 Not Found
Content-Type: application/json

{
  "type": "https://api.grupoapi.com/problems/task-not-found",
  "title": "Task Not Found",
  "status": 404,
  "detail": "Task with ID '999e8400-e29b-41d4-a716-446655440000' does not exist or has been deleted.",
  "instance": "/Automatizacion/999e8400-e29b-41d4-a716-446655440000"
}
```

## Ventajas del RFC 7807

1. **Consistencia**: Todas las respuestas de error siguen el mismo formato
2. **Extensibilidad**: Se pueden añadir campos personalizados sin romper clientes
3. **Documentación**: El campo `type` URI puede enlazar a documentación detallada
4. **Máquinas y Humanos**: Estructura procesable por máquinas con mensajes legibles
5. **Estándar de Industria**: Ampliamente adoptado, compatible con herramientas existentes

## Referencias

- [RFC 7807 Specification](https://tools.ietf.org/html/rfc7807)
- [Problem Details for HTTP APIs](https://datatracker.ietf.org/doc/html/rfc7807)
- [OpenAPI 3.0 Specification](https://spec.openapis.org/oas/v3.0.3)
